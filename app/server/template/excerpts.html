{{ define "excerpts" }}
<div class="container">
    {{ if . }}
    <div class="my-4">
        <h2 class="text-center">{{ .Scripture.ReadableName }} {{ (index .Excerpts
            0).ReadableIndex }}{{ if gt (len .Excerpts) 1 }} - {{ (index .Excerpts
            (sub (len .Excerpts) 1)).ReadableIndex }}{{ end }}</h2>
    </div>

    <div class="d-flex flex-column justify-content-start p-2">
        <div class="d-flex justify-content-start my-3">
            <span class="badge bg-success">Addressed to: {{ .AddressedTo }}</span>
        </div>
        <div class="d-flex justify-content-start">
            <span class="badge bg-secondary">Group: {{ (index .Excerpts 0).Group }}</span>
        </div>
    </div>

    <div class="d-flex justify-content-between my-4">
        {{ if .Previous }}
        <a href="{{ .Previous }}" class="btn btn-primary">&larr; Previous ({{ .Previous }})</a>
        {{ else }}
        <span></span>
        {{ end }}
        {{ if .Up }}
        <a href="{{ .Up }}" class="btn btn-info">&uarr; {{ .UpType }} {{ .Up }} </a>
        {{ end }}
        {{ if .Next }}
        <a href="{{ .Next }}" class="btn btn-primary">Next ({{ .Next }}) &rarr;</a>
        {{ else }}
        <span></span>
        {{ end }}
    </div>

    <div class="card my-3">
        <div class="card-header">
            Text (Devanagari)
        </div>
        <div class="card-body">
            {{ range .Excerpts }}
            <p><strong>{{ .ReadableIndex }}</strong></p>
            <div class="verse">
                {{ range .SourceText }}
                <p class="line">{{ . }}</p>
                {{ end }}
            </div>
            {{ end }}
        </div>
    </div>

    <div class="card my-3">
        <div class="card-header">
            Text (Roman)
        </div>
        <div class="card-body verse">
            {{ range .Excerpts }}
            <p><strong>{{ .ReadableIndex }}</strong></p>
            {{ range .RomanText }}
            <p class="roman-text">{{ . }}</p>
            <!-- <p class="roman-text line">{{ . }}</p> -->
            {{ end }}
            {{ end }}
        </div>
    </div>
    {{ $excerpts := .Excerpts }}
    {{ $firstExcerpt := index .Excerpts 0 }}
    {{ $tags := .GrammaticalTags }}
    {{ range $idx, $aux := .Scripture.Auxiliaries }}
    {{ if eq $aux.Name "pada" }}
    {{/* Special handling for pada auxiliary */}}
    <div class="card my-3">
        <div class="card-header">
            {{ $aux.ReadableName }}
        </div>
        <div class="card-body">
            {{ range $eidx, $excerpt := $excerpts }}
            <p><strong>{{ $excerpt.ReadableIndex }}</strong></p>
            {{- range $pidx, $pada := $excerpt.Padas -}}
            {{- if $pidx }} | {{ end -}}
            {{ if $pada.Found }}
            {{/* Word with dictionary entries */}}
            {{ $dictLink := "" }}
            {{ if gt (len $pada.SurfaceMeanings) 0 }}
            {{ $dictLink = (index $pada.SurfaceMeanings 0).Word }}
            {{ else if gt (len $pada.LemmaMeanings) 0 }}
            {{ $dictLink = (index $pada.LemmaMeanings 0).Word }}
            {{- end -}}
            <span class="pada-word" data-pada-id="pada-{{ $eidx }}-{{ $pidx }}">
                {{ if ne $dictLink "" }}
                <!-- TODO: make this relative -->
                <a href="/dictionaries/monier-williams/words/{{ $dictLink }}" class="text-decoration-none">{{
                    $pada.Word
                    }}</a>
                {{ else }}
                {{ $pada.Word }}
                {{ end }}
            </span>
            {{/* Hidden data for popup */}}
            <div id="pada-{{ $eidx }}-{{ $pidx }}" class="pada-data" style="display: none;">
                <div class="pada-popup-content">
                    <div class="mt-2">
                        {{ template "grammatical-badges" (sliceOf $pada.G $tags) }}
                    </div>
                    {{- if $pada.G.Lemma -}}
                    <p>from <i>{{$pada.G.Lemma}}</i></p>
                    <hr />
                    {{- end -}}
                    {{ if gt (len $pada.SurfaceMeanings) 0 }}
                    <div class="mb-2">
                        {{ range $smidx, $entry := $pada.SurfaceMeanings }}
                        <div class="mt-1">
                            <span class="dict-iast-surface"><em>{{ $entry.IAST }}</em></span>: {{ $entry.Body.Plain }}
                        </div>
                        {{ end }}
                        <hr />
                    </div>
                    {{ end }}
                    {{ if gt (len $pada.LemmaMeanings) 0 }}
                    <div class="mb-2">
                        {{ range $lmidx, $entry := $pada.LemmaMeanings }}
                        <div class="mt-1">
                            <span class="dict-iast-lemma"><em>{{ $entry.IAST }}</em></span>: {{ $entry.Body.Plain }}
                        </div>
                        <hr />
                        {{ end }}
                    </div>
                    {{ end }}
                    {{/* Show buttons to fuzzy search lemma and surface */}}
                    <span class="d-flex justify-content-evenly">
                        {{- if $pada.Slp1NormSurface -}}
                        <a href="/dictionaries/monier-williams/search?q={{ $pada.Slp1NormSurface }}&tl=slp1&mode=fuzzy"
                            class="badge bg-secondary me-1">ðŸ”Ž {{ $pada.G.Surface}}</a>
                        {{- end -}}
                        {{- if (and $pada.Slp1NormLemma (ne $pada.Slp1NormLemma $pada.Slp1NormSurface))}}
                        <a href="/dictionaries/monier-williams/search?q={{ $pada.Slp1NormLemma }}&tl=slp1&mode=fuzzy"
                            class="badge bg-secondary me-1">ðŸ”Ž {{ $pada.G.Lemma }}</a>
                        {{- end -}}
                    </span>
                </div>
            </div>
            {{ else }}
            {{/* Word without dictionary entries */}}
            <span>{{ $pada.Word }}</span>
            {{ end }}
            {{ end }}
            </p>
            {{ end }}
        </div>
    </div>
    {{ else }}
    {{/* Standard auxiliary handling */}}
    {{ with (index $firstExcerpt.Auxiliaries $aux.Name).Text }}
    <div class=" card my-3">
        <div class="card-header">
            {{ $aux.ReadableName }}
        </div>
        <div class="card-body">
            {{ range $excerpts }}
            <p><strong>{{ .ReadableIndex }}</strong></p>
            {{ $auxiliary := index .Auxiliaries $aux.Name }}
            {{ range $auxiliary.Text }}
            <p>{{ . }}</p>
            {{ end }}
            {{ end }}
        </div>
    </div>
    {{ end }}
    {{ end }}
    {{ end }}

    <!-- Grammatical analysis collapsible -->
    <div class="card my-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>Grammatical analysis</div>
            <div>
                <button class="btn btn-sm btn-outline-info me-2" type="button" data-bs-toggle="collapse"
                    data-bs-target="#grammaticalCollapse" aria-expanded="true" aria-controls="grammaticalCollapse">
                    Toggle table
                </button>
            </div>
        </div>
        <div class="card-body collapse" id="grammaticalCollapse">
            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                    <thead>
                        <tr>
                            <th>Source index</th>
                            <th>Surface</th>
                            <th>Lemma</th>
                            <th>Information</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Excerpts }}
                        {{ $ew := . }}
                        {{ $idx := .ReadableIndex }}
                        {{ range $rindex, $row := .Glossings }}
                        {{ range $windex, $g := $row }}
                        <tr>
                            <td class="text-muted small">{{ $idx }}</td>

                            {{/* Surface cell: show dotted underline if dictionary entries exist for surface
                            */}}
                            {{ $surfEntries := index $ew.Words $g.Surface }}
                            <td>
                                {{ if gt (len $surfEntries) 0 }}
                                <span class="dotted-underline" data-bs-toggle="tooltip"
                                    title="{{ range $i, $e := $surfEntries }}{{ if $i }}&#10;&#10;{{ end }}{{ $e.Body.Plain }}{{ end }}">{{
                                    $g.Surface }}</span>
                                {{ else }}
                                <span>{{ $g.Surface }}</span>
                                {{ end }}
                            </td>

                            {{/* Lemma cell: show dotted underline if dictionary entries exist for lemma
                            */}}
                            {{ $lemmaEntries := index $ew.Words $g.Lemma }}
                            <td>
                                {{ if and (ne $g.Lemma "") (gt (len $lemmaEntries) 0) }}
                                {{/* TODO: use similar hover cards as pada text, but without badges and showing up on
                                top right corner */}}
                                <span class="dotted-underline" data-bs-toggle="tooltip"
                                    title="{{ range $i, $e := $lemmaEntries }}{{ if $i }}; {{ end }}{{ $e.Body.Plain }}{{ end }}">{{
                                    $g.Lemma }}</span>
                                {{ else if ne $g.Lemma "" }}
                                <span>{{ $g.Lemma }}</span>
                                {{ else }}
                                <span class="text-muted">N/A</span>
                                {{ end }}
                            </td>

                            <td>
                                {{ template "grammatical-badges" (sliceOf $g $tags) }}
                            </td>
                        </tr>
                        {{ end }}
                        {{ end }}
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <style>
        .dotted-underline {
            border-bottom: 1px dotted currentColor;
            cursor: help;
        }

        .pada-word {
            cursor: pointer;
            position: relative;
        }

        .pada-popup {
            position: absolute;
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
            border: 1px solid var(--bs-border-color);
            border-radius: 4px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 400px;
            max-height: 40vh;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .pada-word a {
            border-bottom: 1px dotted currentColor;
            text-decoration: none;
            cursor: help;
            color: var(--bs-body-color);
            font-weight: bold;
        }
    </style>

    <script>
        // Pada word popup handler
        // initFn will be called by layout body after bootstrap is loaded. This way we can keep JS loading in the end.
        var initFn = (function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl)
            })

            var activePopup = null;

            document.querySelectorAll('.pada-word').forEach(function (wordEl) {
                var padaId = wordEl.getAttribute('data-pada-id');
                var dataEl = document.getElementById(padaId);

                if (!dataEl) return;

                wordEl.addEventListener('mouseenter', function (e) {
                    // Remove any existing popup
                    if (activePopup) {
                        activePopup.remove();
                        activePopup = null;
                    }

                    // Create popup
                    var popup = document.createElement('div');
                    popup.className = 'pada-popup';
                    popup.innerHTML = dataEl.querySelector('.pada-popup-content').innerHTML;

                    // Position popup
                    document.body.appendChild(popup);
                    var rect = wordEl.getBoundingClientRect();
                    popup.style.left = rect.left + 'px';
                    popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';

                    activePopup = popup;
                });

                wordEl.addEventListener('mouseleave', function (e) {
                    setTimeout(function () {
                        if (activePopup && !activePopup.matches(':hover')) {
                            activePopup.remove();
                            activePopup = null;
                        }
                    }, 100);
                });
            });

            // Close popup when clicking outside
            document.addEventListener('click', function (e) {
                if (activePopup && !e.target.closest('.pada-word') && !e.target.closest('.pada-popup')) {
                    activePopup.remove();
                    activePopup = null;
                }
            });
        });
    </script>

    <div class="d-flex justify-content-between my-4">
        {{ if .Previous }}
        <a href="{{ .Previous }}" class="btn btn-primary">&larr; Previous ({{ .Previous }})</a>
        {{ else }}
        <span></span>
        {{ end }}
        {{ if .Up }}
        <a href="{{ .Up }}" class="btn btn-info">&uarr; {{ .UpType }} {{ .Up }} </a>
        {{ end }}
        {{ if .Next }}
        <a href="{{ .Next }}" class="btn btn-primary">Next ({{ .Next }}) &rarr;</a>
        {{ else }}
        <span></span>
        {{ end }}
    </div>

    {{ else }}
    <div class="alert alert-warning mt-4" role="alert">
        No results found!
    </div>
    {{ end }}

</div>
{{ end }}

{{/* Reusable template for grammatical badges */}}
{{ define "grammatical-badges" }}
{{ $g := index . 0 }}
{{ $tags := index . 1 }}
{{ if ne $g.Gramm "" }}
<span class="badge bg-light text-dark me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Gramm }}{{ . }}{{ end }}">{{ $g.Gramm }}</span>
{{ end }}
{{ if ne $g.Root "" }}
<span class="badge bg-secondary me-1">Root={{ $g.Root }}</span>
{{ end }}
{{ if ne $g.Number "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Number }}{{ . }}{{ end }}">Number:{{ $g.Number }}</span>
{{ end }}
{{ if ne $g.Gender "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Gender }}{{ . }}{{ end }}">Gender:{{ $g.Gender }}</span>
{{ end }}
{{ if ne $g.Case "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Case }}{{ . }}{{ end }}">Case:{{ $g.Case }}</span>
{{ end }}
{{ if ne $g.Tense "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Tense }}{{ . }}{{ end }}">Tense:{{ $g.Tense }}</span>
{{ end }}
{{ if ne $g.Voice "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Voice }}{{ . }}{{ end }}">Voice:{{ $g.Voice }}</span>
{{ end }}
{{ if ne $g.Person "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Person }}{{ . }}{{ end }}">Person:{{ $g.Person }}</span>
{{ end }}
{{ if ne $g.Mood "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Mood }}{{ . }}{{ end }}">Mood:{{ $g.Mood }}</span>
{{ end }}
{{ range $mi, $mod := $g.Modifiers }}
<span class="badge bg-secondary me-1">{{ $mod }}</span>
{{ end }}
{{ end }}