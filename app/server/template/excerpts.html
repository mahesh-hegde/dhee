{{ define "excerpts" }}
<div class="container">
    {{ if . }}
    <div class="my-4">
        <h2 class="text-center">{{ .Scripture.ReadableName }} {{ (index .Excerpts
            0).ReadableIndex }}{{ if gt (len .Excerpts) 1 }} - {{ (index .Excerpts
            (sub (len .Excerpts) 1)).ReadableIndex }}{{ end }}</h2>
    </div>

    <div class="d-flex flex-column justify-content-start p-2">
        <div class="d-flex justify-content-start my-3">
            <span class="badge bg-success">Addressed to: {{ .AddressedTo }}</span>
        </div>
        <div class="d-flex justify-content-start">
            <span class="badge bg-secondary">Group: {{ (index .Excerpts 0).Group }}</span>
        </div>
    </div>

    <div class="d-flex justify-content-between my-4">
        {{ if .Previous }}
        <a href="{{ .Previous }}" class="btn btn-primary">&larr; Previous ({{ .Previous }})</a>
        {{ else }}
        <span></span>
        {{ end }}
        {{ if .Up }}
        <a href="{{ .Up }}" class="btn btn-info">&uarr; {{ .UpType }} {{ .Up }} </a>
        {{ end }}
        {{ if .Next }}
        <a href="{{ .Next }}" class="btn btn-primary">Next ({{ .Next }}) &rarr;</a>
        {{ else }}
        <span></span>
        {{ end }}
    </div>

    <div class="card my-3">
        <div class="card-header">
            Text (Devanagari)
        </div>
        <div class="card-body" id="source-text-section">
            {{ range .Excerpts }}
            <p><strong>{{ .ReadableIndex }}</strong></p>
            <div class="verse">
                {{ range .SourceText }}
                <p class="line">{{ . }}</p>
                {{ end }}
            </div>
            {{ end }}
        </div>
    </div>

    <div class="card my-3">
        <div class="card-header">
            Text (Roman)
        </div>
        <div class="card-body verse" id="roman-text-section">
            {{ range .Excerpts }}
            <p><strong>{{ .ReadableIndex }}</strong></p>
            {{ range .RomanText }}
            <p class="roman-text">{{ . }}</p>
            <!-- <p class="roman-text line">{{ . }}</p> -->
            {{ end }}
            {{ end }}
        </div>
    </div>
    {{ $excerpts := .Excerpts }}
    {{ $firstExcerpt := index .Excerpts 0 }}
    {{ $tags := .GrammaticalTags }}
    {{ range $idx, $aux := .Scripture.Auxiliaries }}
    {{ if eq $aux.Name "pada" }}
    {{/* Special handling for pada auxiliary */}}
    <div class="card my-3">
        <div class="card-header">
            {{ $aux.ReadableName }}
        </div>
        <div class="card-body">
            {{ range $eidx, $excerpt := $excerpts }}
            <p><strong>{{ $excerpt.ReadableIndex }}</strong></p>
            {{- range $pidx, $pada := $excerpt.Padas -}}
            {{- if $pidx }} | {{ end -}}
            {{ if $pada.Found }}
            {{/* Word with dictionary entries */}}
            {{ $dictLink := "" }}
            {{ if $pada.SurfaceMeaning.Word }}
            {{ $dictLink = $pada.SurfaceMeaning.Word }}
            {{ else if $pada.LemmaMeaning.Word }}
            {{ $dictLink = $pada.LemmaMeaning.Word }}
            {{- end -}}
            <span class="pada-word" data-pada-id="pada-{{ $eidx }}-{{ $pidx }}">
                {{ if ne $dictLink "" }}
                <!-- TODO: make this relative -->
                <a href="/dictionaries/monier-williams/words/{{ $dictLink }}" class="text-decoration-none">{{
                    $pada.Word
                    }}</a>
                {{ else }}
                {{ $pada.Word }}
                {{ end }}
            </span>
            {{/* Hidden data for popup */}}
            <div id="pada-{{ $eidx }}-{{ $pidx }}" class="pada-data" style="display: none;">
                <div class="pada-popup-content">
                    <div class="mt-2">
                        {{ template "grammatical-badges" (sliceOf $pada.G $tags) }}
                    </div>
                    {{- if $pada.G.Lemma -}}
                    <p>from <i>{{$pada.G.Lemma}}</i></p>
                    <hr />
                    {{- end -}}
                    {{ if gt (len $pada.SurfaceMeaning.Meanings) 0 }}
                    <div class="mb-2">
                        {{ $iast := $pada.SurfaceMeaning.IAST }}
                        {{ range $smidx, $entry := $pada.SurfaceMeaning.Meanings }}
                        <div class="mt-1">
                            <span class="dict-iast-surface"><em>{{ $iast }}</em></span>: {{ $entry.Body.Plain }}
                        </div>
                        {{ end }}
                        <hr />
                    </div>
                    {{ end }}
                    {{ if $pada.LemmaMeaning.Word }}
                    <div class="mb-2">
                        {{ $iast := $pada.LemmaMeaning.IAST }}
                        {{ range $lmidx, $entry := $pada.LemmaMeaning.Meanings }}
                        <div class="mt-1">
                            <span class="dict-iast-lemma"><em>{{ $iast }}</em></span>: {{ $entry.Body.Plain }}
                        </div>
                        <hr />
                        {{ end }}
                    </div>
                    {{ end }}
                    {{/* Show buttons to fuzzy search lemma and surface */}}
                    <span class="d-flex justify-content-evenly">
                        {{- if $pada.Slp1NormSurface -}}
                        <a href="/dictionaries/monier-williams/search?q={{ $pada.Slp1NormSurface }}&tl=slp1&mode=fuzzy"
                            class="badge bg-secondary me-1">ðŸ”Ž {{ $pada.G.Surface}}</a>
                        {{- end -}}
                        {{- if (and $pada.Slp1NormLemma (ne $pada.Slp1NormLemma $pada.Slp1NormSurface))}}
                        <a href="/dictionaries/monier-williams/search?q={{ $pada.Slp1NormLemma }}&tl=slp1&mode=fuzzy"
                            class="badge bg-secondary me-1">ðŸ”Ž {{ $pada.G.Lemma }}</a>
                        {{- end -}}
                    </span>
                </div>
            </div>
            {{ else }}
            {{/* Word without dictionary entries */}}
            <span>{{ $pada.Word }}</span>
            {{ end }}
            {{ end }}
            </p>
            {{ end }}
        </div>
    </div>
    {{ else }}
    {{/* Standard auxiliary handling */}}
    {{ with (index $firstExcerpt.Auxiliaries $aux.Name).Text }}
    <div class=" card my-3">
        <div class="card-header">
            {{ $aux.ReadableName }}
        </div>
        <div class="card-body">
            {{ range $excerpts }}
            <p><strong>{{ .ReadableIndex }}</strong></p>
            {{ $auxiliary := index .Auxiliaries $aux.Name }}
            {{ range $auxiliary.Text }}
            <p>{{ . }}</p>
            {{ end }}
            {{ end }}
        </div>
    </div>
    {{ end }}
    {{ end }}
    {{ end }}

    {{ if $firstExcerpt.Notes }}
    <div class="card my-3">
        <div class="card-header">
            Notes
        </div>
        <div class="card-body">
            {{ range .Excerpts }}
            {{ if .Notes }}
            <p><strong>{{ .ReadableIndex }}</strong></p>
            {{ range .Notes }}
            <div>{{ . | safe }}</div>
            {{ end }}
            {{ end }}
            {{ end }}
        </div>
    </div>
    {{ end }}

    <!-- Grammatical analysis collapsible -->
    <div class="card my-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>Grammatical analysis</div>
            <div>
                <button class="btn btn-sm btn-outline-info me-2" type="button" data-bs-toggle="collapse"
                    data-bs-target="#grammaticalCollapse" aria-expanded="true" aria-controls="grammaticalCollapse">
                    Toggle table
                </button>
            </div>
        </div>
        <div class="card-body collapse" id="grammaticalCollapse">
            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                    <thead>
                        <tr>
                            <th>Source index</th>
                            <th>Surface</th>
                            <th>Lemma</th>
                            <th>Information</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Excerpts }}
                        {{ $ew := . }}
                        {{ $idx := .ReadableIndex }}
                        {{ range $rindex, $row := .Glossings }}
                        {{ range $windex, $g := $row }}
                        <tr>
                            <td class="text-muted small">{{ $idx }}</td>

                            {{/* Surface cell: always show hover card with search link */}}
                            {{ $surfEntry := index $ew.Words $g.Surface }}
                            <td>
                                {{ if $surfEntry.IAST }}
                                <span class="table-word table-word-underline"
                                    data-word-id="surf-{{ $rindex }}-{{ $windex }}">{{ $g.Surface }}</span>
                                {{ else }}
                                <span class="table-word" data-word-id="surf-{{ $rindex }}-{{ $windex }}">{{ $g.Surface
                                    }}</span>
                                {{ end }}
                                <div id="surf-{{ $rindex }}-{{ $windex }}" class="table-word-data"
                                    style="display: none;">
                                    <div class="table-word-popup-content">
                                        {{ if $surfEntry.IAST }}
                                        {{ $iast := $surfEntry.IAST }}
                                        {{ range $i, $e := $surfEntry.Meanings }}
                                        <div class="mb-2">
                                            <span class="dict-iast-surface"><em>{{ $iast }}</em></span>: {{
                                            $e.Body.Plain }}
                                        </div>
                                        {{ if lt $i (sub (len $surfEntry.Meanings) 1) }}
                                        <hr />{{ end }}
                                        {{ end }}
                                        <hr />
                                        {{ end }}
                                        <a href="/dictionaries/monier-williams/search?q={{ $g.Surface }}&tl=iast&mode=fuzzy"
                                            class="badge bg-secondary">ðŸ”Ž {{ $g.Surface }}</a>
                                    </div>
                                </div>
                            </td>

                            {{/* Lemma cell: always show hover card with search link */}}
                            {{ $lemmaEntry := index $ew.Words $g.Lemma }}
                            <td>
                                {{ if ne $g.Lemma "" }}
                                {{ if $lemmaEntry.Word }}
                                <span class="table-word table-word-underline"
                                    data-word-id="lemma-{{ $rindex }}-{{ $windex }}">{{ $g.Lemma }}</span>
                                {{ else }}
                                <span class="table-word" data-word-id="lemma-{{ $rindex }}-{{ $windex }}">{{ $g.Lemma
                                    }}</span>
                                {{ end }}
                                <div id="lemma-{{ $rindex }}-{{ $windex }}" class="table-word-data"
                                    style="display: none;">
                                    <div class="table-word-popup-content">
                                        {{ if $lemmaEntry.Word }}
                                        {{ $iast := $lemmaEntry.IAST}}
                                        {{ range $i, $e := $lemmaEntry.Meanings }}
                                        <div class="mb-2">
                                            <span class="dict-iast-lemma"><em>{{ $iast }}</em></span>: {{
                                            $e.Body.Plain }}
                                        </div>
                                        {{ if lt $i (sub (len $lemmaEntry.Meanings) 1) }}
                                        <hr />{{ end }}
                                        {{ end }}
                                        <hr />
                                        {{ end }}
                                        <a href="/dictionaries/monier-williams/search?q={{ $g.Lemma }}&tl=iast&mode=fuzzy"
                                            class="badge bg-secondary">ðŸ”Ž {{ $g.Lemma }}</a>
                                    </div>
                                </div>
                                {{ else }}
                                <span class="text-muted">N/A</span>
                                {{ end }}
                            </td>

                            <td>
                                {{ template "grammatical-badges" (sliceOf $g $tags) }}
                            </td>
                        </tr>
                        {{ end }}
                        {{ end }}
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <style>
        .dotted-underline {
            border-bottom: 1px dotted currentColor;
            cursor: help;
        }

        .pada-word {
            cursor: pointer;
            position: relative;
        }

        .pada-popup {
            position: absolute;
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
            border: 1px solid var(--bs-border-color);
            border-radius: 4px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 400px;
            max-height: 40vh;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .pada-word a {
            border-bottom: 1px dotted currentColor;
            text-decoration: none;
            cursor: help;
            color: var(--bs-body-color);
            font-weight: bold;
        }

        .table-word {
            cursor: pointer;
        }

        .table-word-underline {
            border-bottom: 1px dotted currentColor;
        }

        .table-word-popup {
            position: absolute;
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
            border: 1px solid var(--bs-border-color);
            border-radius: 4px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 400px;
            max-height: 40vh;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .search-result-window {
            position: fixed;
            top: 10vh;
            left: 30vw;
            z-index: 1060;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            border: 1px solid var(--bs-border-color);
            border-radius: .3rem;
            box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15);
            max-width: 40vw;
            max-height: 50vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .search-result-title-bar {
            height: 2em;
            background-color: #003300;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .search-result-content {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .search-result-window .btn-close {
            margin-right: 0.5em;
            filter: invert(1) grayscale(100%) brightness(200%);
        }
    </style>

    <script>
        // Pada word popup handler and table word popup handler
        // initFn will be called by layout body after bootstrap is loaded. This way we can keep JS loading in the end.
        var initFn = (function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl)
            })

            var activePopup = null;

            // Pada word hover cards
            document.querySelectorAll('.pada-word').forEach(function (wordEl) {
                var padaId = wordEl.getAttribute('data-pada-id');
                var dataEl = document.getElementById(padaId);

                if (!dataEl) return;

                wordEl.addEventListener('mouseenter', function (e) {
                    // Remove any existing popup
                    if (activePopup) {
                        activePopup.remove();
                        activePopup = null;
                    }

                    // Create popup
                    var popup = document.createElement('div');
                    popup.className = 'pada-popup';
                    popup.innerHTML = dataEl.querySelector('.pada-popup-content').innerHTML;

                    // Position popup
                    document.body.appendChild(popup);
                    var rect = wordEl.getBoundingClientRect();
                    popup.style.left = rect.left + 'px';
                    popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';

                    activePopup = popup;
                });

                wordEl.addEventListener('mouseleave', function (e) {
                    setTimeout(function () {
                        if (activePopup && !activePopup.matches(':hover')) {
                            activePopup.remove();
                            activePopup = null;
                        }
                    }, 100);
                });
            });

            // Table word hover cards
            document.querySelectorAll('.table-word').forEach(function (wordEl) {
                var wordId = wordEl.getAttribute('data-word-id');
                var dataEl = document.getElementById(wordId);

                if (!dataEl) return;

                wordEl.addEventListener('mouseenter', function (e) {
                    // Remove any existing popup
                    if (activePopup) {
                        activePopup.remove();
                        activePopup = null;
                    }

                    // Create popup
                    var popup = document.createElement('div');
                    popup.className = 'table-word-popup';
                    popup.innerHTML = dataEl.querySelector('.table-word-popup-content').innerHTML;

                    // Position popup
                    document.body.appendChild(popup);
                    var rect = wordEl.getBoundingClientRect();
                    popup.style.left = rect.left + 'px';
                    popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';

                    activePopup = popup;
                });

                wordEl.addEventListener('mouseleave', function (e) {
                    setTimeout(function () {
                        if (activePopup && !activePopup.matches(':hover')) {
                            activePopup.remove();
                            activePopup = null;
                        }
                    }, 100);
                });
            });

            function makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                const dragHandle = element.querySelector('.search-result-title-bar');
                if (!dragHandle) { return; }
                dragHandle.onmousedown = dragMouseDown;

                function dragMouseDown(e) {
                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a, button')) {
                        return;
                    }
                    e = e || window.event;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                }

                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }

            // Text selection search popup
            function setupTextSelectionSearch(elementId, transliteration, fuzziness) {
                const textEl = document.getElementById(elementId);
                if (!textEl) return;

                textEl.addEventListener('mouseup', function (e) {
                    const searchResultWindow = document.querySelector('.search-result-window');
                    if (searchResultWindow && searchResultWindow.contains(e.target)) {
                        return;
                    }

                    if (activePopup) {
                        activePopup.remove();
                        activePopup = null;
                    }

                    setTimeout(() => {
                        const selection = window.getSelection();
                        if (!selection.rangeCount) return;
                        const selectedText = selection.toString().trim();

                        if (selectedText.length > 0 && (selectedText.match(/\s/g) || []).length <= 2) {
                            const range = selection.getRangeAt(0);
                            const rect = range.getBoundingClientRect();

                            if (e.target.closest('.pada-popup, .table-word-popup, .roman-selection-popup')) return;

                            const popup = document.createElement('div');
                            popup.className = 'roman-selection-popup';
                            popup.style.position = 'absolute';
                            popup.style.zIndex = 1050;

                            const searchBadge = document.createElement('button');
                            searchBadge.className = 'btn btn-sm btn-info';
                            searchBadge.innerHTML = `ðŸ”Ž ${selectedText}`;

                            popup.appendChild(searchBadge);
                            document.body.appendChild(popup);

                            const popupRect = popup.getBoundingClientRect();
                            popup.style.left = `${rect.right + window.scrollX - popupRect.width}px`;
                            popup.style.top = `${rect.bottom + window.scrollY + 5}px`;

                            activePopup = popup;

                            searchBadge.addEventListener('click', function () {
                                if (activePopup) {
                                    activePopup.remove();
                                    activePopup = null;
                                }

                                const existingResultWindow = document.querySelector('.search-result-window');
                                if (existingResultWindow) {
                                    existingResultWindow.remove();
                                }

                                const url = `/dictionaries/monier-williams/search?q=${encodeURIComponent(selectedText)}&tl=${transliteration}&mode=fuzzy&preview=true&fuzziness=${fuzziness}`;
                                fetch(url)
                                    .then(response => response.text())
                                    .then(html => {
                                        const resultWindow = document.createElement('div');
                                        resultWindow.className = 'search-result-window';

                                        const titleBar = document.createElement('div');
                                        titleBar.className = 'search-result-title-bar';

                                        const closeButton = document.createElement('button');
                                        closeButton.className = 'btn-close';
                                        closeButton.setAttribute('aria-label', 'Close');
                                        titleBar.appendChild(closeButton);

                                        const contentDiv = document.createElement('div');
                                        contentDiv.className = 'search-result-content';
                                        contentDiv.innerHTML = html;

                                        resultWindow.appendChild(titleBar);
                                        resultWindow.appendChild(contentDiv);

                                        document.body.appendChild(resultWindow);

                                        closeButton.onclick = function () {
                                            resultWindow.remove();
                                        };

                                        makeDraggable(resultWindow);
                                    }).catch(err => console.error("Failed to fetch search preview:", err));
                            });
                        }
                    }, 10);
                });
            }
            setupTextSelectionSearch('roman-text-section', 'iast', 2);
            setupTextSelectionSearch('source-text-section', 'dn', 3);

            // Close popup when clicking outside
            document.addEventListener('click', function (e) {
                if (activePopup && !activePopup.contains(e.target) && !e.target.closest('.pada-word') && !e.target.closest('.table-word')) {
                    activePopup.remove();
                    activePopup = null;
                }

                const resultWindow = document.querySelector('.search-result-window');
                if (resultWindow && !resultWindow.contains(e.target) && !e.target.closest('.roman-selection-popup')) {
                    resultWindow.remove();
                }
            });
        });
    </script>

    <div class="d-flex justify-content-between my-4">
        {{ if .Previous }}
        <a href="{{ .Previous }}" class="btn btn-primary">&larr; Previous ({{ .Previous }})</a>
        {{ else }}
        <span></span>
        {{ end }}
        {{ if .Up }}
        <a href="{{ .Up }}" class="btn btn-info">&uarr; {{ .UpType }} {{ .Up }} </a>
        {{ end }}
        {{ if .Next }}
        <a href="{{ .Next }}" class="btn btn-primary">Next ({{ .Next }}) &rarr;</a>
        {{ else }}
        <span></span>
        {{ end }}
    </div>

    {{ else }}
    <div class="alert alert-warning mt-4" role="alert">
        No results found!
    </div>
    {{ end }}

</div>
{{ end }}

{{/* Reusable template for grammatical badges */}}
{{ define "grammatical-badges" }}
{{ $g := index . 0 }}
{{ $tags := index . 1 }}
{{ if ne $g.Gramm "" }}
<span class="badge bg-light text-dark me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Gramm }}{{ . }}{{ end }}">{{ $g.Gramm }}</span>
{{ end }}
{{ if ne $g.Root "" }}
<span class="badge bg-secondary me-1">Root={{ $g.Root }}</span>
{{ end }}
{{ if ne $g.Number "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Number }}{{ . }}{{ end }}">Number:{{ $g.Number }}</span>
{{ end }}
{{ if ne $g.Gender "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Gender }}{{ . }}{{ end }}">Gender:{{ $g.Gender }}</span>
{{ end }}
{{ if ne $g.Case "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Case }}{{ . }}{{ end }}">Case:{{ $g.Case }}</span>
{{ end }}
{{ if ne $g.Tense "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Tense }}{{ . }}{{ end }}">Tense:{{ $g.Tense }}</span>
{{ end }}
{{ if ne $g.Voice "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Voice }}{{ . }}{{ end }}">Voice:{{ $g.Voice }}</span>
{{ end }}
{{ if ne $g.Person "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Person }}{{ . }}{{ end }}">Person:{{ $g.Person }}</span>
{{ end }}
{{ if ne $g.Mood "" }}
<span class="badge bg-secondary me-1" data-bs-toggle="tooltip"
    title="{{ with index $tags $g.Mood }}{{ . }}{{ end }}">Mood:{{ $g.Mood }}</span>
{{ end }}
{{ range $mi, $mod := $g.Modifiers }}
<span class="badge bg-secondary me-1">{{ $mod }}</span>
{{ end }}
{{ end }}